edition: 3.0.0
name: ots-table-backup
access: '{{ access }}'
vars:
  region: '{{ region }}'
  role: '{{ roleArn }}'
    
resources:
  tableBackup:
    component: fc3
    actions:
      pre-deploy:
        - run: mvn package -q -DskipTests
          path: ./OTSTableBackup
    props:
      region: ${vars.region}
      role: ${vars.role}
      description: OTS Table Backup Function
      runtime: custom
      memorySize: 512
      timeout: 600
      customRuntimeConfig:
        command:
          - java
        args:
          - org.springframework.boot.loader.JarLauncher
        port: 9000
      instanceConcurrency: 1
      instanceLifecycleConfig:
        preStop:
          handler: default
          timeout: 60
        initializer:
          handler: default
          timeout: 60
      environmentVariables:
        SOURCE_ENDPOINT: '{{ sourceEndpoint }}'
        TARGET_ENDPOINT: '{{ targetEndpoint }}'
        SOURCE_TABLE: '{{ sourceTable }}'
        TARGET_TABLE: '{{ targetTable }}'
        DROP_IF_EXIST: '{{ dropIfExist }}'
        TUNNEL_TYPE: '{{ tunnelType }}'
        {{if backupEndTime !== ''}}
        BACKUP_END_TIME: '{{ backupEndTime }}'
        {{/if}}
      functionName: '{{ functionName }}'
      code: ./OTSTableBackup/target/OTSTableBackup.jar
      {{if cronExpression !== ''}}
      triggers:
        - qualifier: LATEST
          triggerName: cron
          triggerType: timer
          triggerConfig:
            payload: ''
            cronExpression: '{{ cronExpression }}'
      {{/if}}
    
  tableMock:
    component: fc3
    actions:
      pre-deploy:
        - run: mvn package -q -DskipTests
          path: ./OTSTableMock
    props:
      region: ${vars.region}
      role: ${vars.role}
      description: OTS Table Mock Function
      runtime: custom
      memorySize: 512
      timeout: 600
      customRuntimeConfig:
        command:
          - java
        args:
          - org.springframework.boot.loader.JarLauncher
        port: 9000
      instanceConcurrency: 1
      environmentVariables:
        SOURCE_ENDPOINT: '{{ sourceEndpoint }}'
        SOURCE_TABLE: '{{ sourceTable }}'
      functionName: '{{ functionName }}_table_mock'
      code: ./OTSTableMock/target/OTSTableMock.jar
